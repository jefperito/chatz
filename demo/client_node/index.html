<!DOCTYPE HTML>
<html lang="pt-BR">
<head>
    <title>CLIENTE DO CHAT 0.1</title>
    <script src="http://localhost:8081/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="./jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="./../../client/chatz.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script type="text/javascript">
        $(document).ready(function() {
            chatz.init('http://localhost:8081');

            var id = prompt('Digite o id', '1');
            var name = prompt('Digite o seu nome', 'Jeferson');
            var usersOnChat;

            chatz.addUser({id: id, name: name}, function (error, user) {
                if (error) {
                    alert('Houve um erro registrando o usuário ' + JSON.stringify(error));
                    return ;
                }

                chatz.joinRoom('1', function(error) {
                    if (error) {
                        alert('Não foi possível entrar na sala');
                    }
                });

                chatz.getUsers(function(error, users) {
                    if (error) {
                        alert('Houve um erro obtendo os usuários');
                        return ;
                    }

                    usersOnChat = users;
                    var ids = Object.keys(users);

                    ids.forEach(function(_id) {
                        $('#users_list').append($('<li>', {
                            id: 'ul_' + _id,
                            class: _id == user.id ? 'me' : ''
                        }).append(usersOnChat[_id].name));
                    });

                    chatz.getRooms(function(rooms) {
                        rooms.forEach(function(room) {
                            room.messages.forEach(function(message) {
                                $('#msg_area').append('<b>' + message.sender.name + ':</b> ' + message.body + '<br/>');
                            });
                        });
                    });
                });
            });

            chatz.addEvent('newUser', function(user) {
                usersOnChat[user.id] = user;
                $('#users_list').append($('<li>', {
                    id: 'ul_' + user.id
                }).append(user.name));
            });

            chatz.addEvent('removeUser', function(user) {
                $('#ul_' + user.id).remove();
            });

            chatz.addEvent('receiveMsg', function(message) {
                var sender = usersOnChat[message.sender.id];
                $('#msg_area').append('<b>' + sender.name + ':</b> ' + message.body + '<br/>');
            });

            $('#send_button').click(function() {
                chatz.sendMessage({
                    room_id: 1,
                    body: document.getElementById('msg').value
                },function(error) {
                    if (error) {
                        alert('Houve um erro no envio de mensagem');
                        return;
                    }

                    $('#msg_area').append('<b>' + name + ':</b> ' + document.getElementById('msg').value + '<br/>');
                    $('#msg').val('');
                });
            });
        });

        function handle(event) {
            if (event.keyCode == 13) {
                $('#send_button').click();
            }
        }
    </script>
</head>
<body>
    <div id="msg_area" class="msg_area"></div>
    <ul id="users_list" class="users_list"></ul><br/>
    <div class="container_msg">
        <input id="msg" name="msg" type="text" size="50" onkeyup="handle(event);" />
        <button id="send_button" type="button">Send</button>
    </div>
</body>
</html>